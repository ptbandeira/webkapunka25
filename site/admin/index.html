<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
  </head>
  <body>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script src="/js/cms-preview.js"></script>
    <script>
      const h = window.h;
      const createClass = window.createClass;

      // Load site in an iframe and apply preview data safely (no layout changes)
      function makeFrame(src, applier){
        return createClass({
          componentDidMount(){
            this._onload = () => {
              try{ const w = this._iframe && this._iframe.contentWindow; if (w && typeof w[applier]==='function') w[applier](this.props.data); }catch(e){}
            };
            if (this._iframe) this._iframe.addEventListener('load', this._onload);
          },
          componentWillUnmount(){ if (this._iframe && this._onload) this._iframe.removeEventListener('load', this._onload); },
          render(){ return h('iframe', { src, style:{ width:'100%', height:'90vh', border:0 }, ref: (el)=>{ this._iframe = el; } }); }
        });
      }

      CMS.registerPreviewTemplate('home', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = makeFrame('/?cms-preview=1', '__applyHome');
        return h(Frame, { data });
      });

      // About: preview-only safe mapping
      CMS.registerPreviewTemplate('about', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = makeFrame('/about.html?cms-preview=1', '__applyAbout');
        return h(Frame, { data });
      });

      // Shop: preview-only safe mapping
      CMS.registerPreviewTemplate('shop', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = makeFrame('/shop.html?cms-preview=1', '__applyShop');
        return h(Frame, { data });
      });

      // Contact: preview-only safe mapping
      CMS.registerPreviewTemplate('contact', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = makeFrame('/contact.html?cms-preview=1', '__applyContact');
        return h(Frame, { data });
      });

      function pagePathForSlug(slug){
        switch(String(slug||'').toLowerCase()){
          case 'about': return '/about.html';
          case 'shop': return '/shop.html';
          case 'contact': return '/contact.html';
          default: return '/index.html';
        }
      }

      function registerLangPreview(collName, lang){
        CMS.registerPreviewTemplate(collName, ({ entry }) => {
          const data = entry.get('data').toJS();
          const slug = entry.get('slug');
          const src = pagePathForSlug(slug)+`?cms-preview=1&lang=${lang}`;
          const Frame = makeFrame(src, '__applyPage');
          return h(Frame, { data });
        });
      }

      registerLangPreview('pages_en', 'en');
      registerLangPreview('pages_pt', 'pt');
      registerLangPreview('pages_es', 'es');

      // i18n files preview: load homepage with ?lang to preview header/footer copy
      CMS.registerPreviewTemplate('i18n_pt', ({ entry }) => {
        const Frame = makeFrame('/?cms-preview=1&lang=pt', '__noop');
        return h(Frame, { data: {} });
      });
      CMS.registerPreviewTemplate('i18n_es', ({ entry }) => {
        const Frame = makeFrame('/?cms-preview=1&lang=es', '__noop');
        return h(Frame, { data: {} });
      });
    </script>
  </body>
  
</html>
