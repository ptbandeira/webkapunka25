<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
  </head>
  <body>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script src="/js/cms-preview.js"></script>
    <script>
      const h = window.h;
      const createClass = window.createClass;

      // Load site in an iframe and apply preview data safely (no layout changes)
      CMS.registerPreviewTemplate('home', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = createClass({
          componentDidMount() {
            const iframe = this.base.querySelector('iframe');
            if (!iframe) return;
            iframe.addEventListener('load', () => {
              try {
                const w = iframe.contentWindow;
                if (w && typeof w.__applyHome === 'function') {
                  w.__applyHome(data);
                }
              } catch (e) { /* preview should never crash */ }
            });
          },
          render() { return h('iframe', { src: '/?cms-preview=1', style: { width:'100%', height:'90vh', border:0 } }); }
        });
        return h(Frame);
      });

      // About: preview-only safe mapping
      CMS.registerPreviewTemplate('about', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = createClass({
          componentDidMount() {
            const iframe = this.base.querySelector('iframe');
            if (!iframe) return;
            iframe.addEventListener('load', () => {
              try {
                const w = iframe.contentWindow;
                if (w && typeof w.__applyAbout === 'function') w.__applyAbout(data);
              } catch (e) {}
            });
          },
          render() { return h('iframe', { src: '/about.html?cms-preview=1', style: { width:'100%', height:'90vh', border:0 } }); }
        });
        return h(Frame);
      });

      // Shop: preview-only safe mapping
      CMS.registerPreviewTemplate('shop', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = createClass({
          componentDidMount() {
            const iframe = this.base.querySelector('iframe');
            if (!iframe) return;
            iframe.addEventListener('load', () => {
              try {
                const w = iframe.contentWindow;
                if (w && typeof w.__applyShop === 'function') w.__applyShop(data);
              } catch (e) {}
            });
          },
          render() { return h('iframe', { src: '/shop.html?cms-preview=1', style: { width:'100%', height:'90vh', border:0 } }); }
        });
        return h(Frame);
      });

      // Contact: preview-only safe mapping
      CMS.registerPreviewTemplate('contact', ({ entry }) => {
        const data = entry.get('data').toJS();
        const Frame = createClass({
          componentDidMount() {
            const iframe = this.base.querySelector('iframe');
            if (!iframe) return;
            iframe.addEventListener('load', () => {
              try {
                const w = iframe.contentWindow;
                if (w && typeof w.__applyContact === 'function') w.__applyContact(data);
              } catch (e) {}
            });
          },
          render() { return h('iframe', { src: '/contact.html?cms-preview=1', style: { width:'100%', height:'90vh', border:0 } }); }
        });
        return h(Frame);
      });
    </script>
  </body>
  
</html>
